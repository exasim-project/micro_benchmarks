case:
  type: CaseOnDisk
  origin: ${{yaml.location}}/../basicSetup
  uses:
      - fvSchemes: fvSchemes.NEON
      - fvSolution: fvSolution.NEON
      - controlDict: controlDict.NEON
  post_build:
      - shell: ${{yaml.location}}/scripts/getMesh.sh
      - shell: ${{yaml.location}}/scripts/getFlowFieldDDES.sh
      - shell: sed -i '/CFDWT_Out/,/}/s/type.*/type fixedValue;/' 0/p
      - turbulenceProperties:
           simulationType: LES
      - controlDict:
           writeFormat: binary
           libs: ["libOGL.so"]
           endTime: 0.005
variation:
      - operation: decomposePar
        schema: "run_{partition}/deco_{numberOfSubdomains}"
        common:
            method: multiLevel
            tasksPerNode: 76
            methods: ["kahip", "kahip", "kahip"]
            distribution: ["auto", 4, 19]
            levels: ["node", "gpu", "cpu"]
        generator:
            key: coeff
            values: [4, 8, 10, 15, 30, 60]
            template:
              - numberOfSubdomains: ${{ coeff * 76 }}
                partition: CPU
        variation:
          - operation: fvSolution
            schema: "{solver}{preconditioner}"
            values:
              - set: solvers/p
                solver: PCG
                executor: CPU
                preconditioner: DIC
                smoother: none
postProcess:
  queries: ["executor", "preconditioner", "ranksPerGPU", "nCells", "numberOfSubdomains", "fuse", "ClockTime", "timeStepContErrors_sumLocal"]
  matcher:
    - regexp: '\[OGL LOG\]\[Proc: 0\]{field}: {name}: (?P<{name}>[0-9.]*) \[ms\]'
      name: ogl_matcher
      args: ["field", "name"]
    - regexp: '\[INFO\] {name}: (?P<{name}>[0-9.]*) \[ms\]'
      name: info_matcher
      args: ["name"]
    - regexp: 'ExecutionTime = (?P<{name}>[0-9.]+) s'
      name: exec_time_matcher
      args: ["name"]
    - regexp: '^.*?ClockTime\s*=\s*(?P<{name}>\d+(?:\.\d+)?)\s*s\b'
      name: clock_time_matcher
      args: ["name"]
  log:
    - matcher: info_matcher
      args: ["MomentumPredictor"]
      type: average
    - matcher: info_matcher
      args: ["MatrixAssemblyPI"]
      type: average
    - matcher: info_matcher
      args: ["MatrixAssemblyPII"]
      type: average
    - matcher: info_matcher
      args: ["MatrixAssemblyU"]
      type: average
    - matcher: info_matcher
      args: ["TimeStep"]
      type: average
    - matcher: exec_time_matcher
      args: ["execTimeDelta"]
      type: diff_mean
    - matcher: clock_time_matcher
      args: ["clockTimeDelta"]
      type: diff_mean
    - matcher: info_matcher
      args: ["PIMPLEStep"]
      type: average
    - matcher: info_matcher
      args: ["SolveP"]
      type: average
    - matcher: ogl_matcher
      args: ["p", "solve"]
      type: average
    - matcher: ogl_matcher
      args: ["p", "solve_multi_gpu"]
      type: average
    - matcher: ogl_matcher
      args: ["p", "copy_x_back"]
      type: average
    - matcher: ogl_matcher
      args: ["p", "init_precond"]
      type: average
    - matcher: ogl_matcher
      args: ["p", "perform_all_to_all_update"]
      type: average
    - matcher: ogl_matcher
      args: ["p", "perform_pairwise_update"]
      type: average
    - matcher: ogl_matcher
      args: ["p", "reorder_matrix_data"]
      type: average
    - matcher: ogl_matcher
      args: ["p_distributed_matrix", "call_update"]
      type: average
    - matcher: transpEqn
      args: ["p"]
      type: average
